# Hyper-Local Pollen Alert (.cursorrules)

## Целевая платформа и технологии
- **Версия ОС**: iOS 26.2+
- **Язык**: Swift 6 (Strict Concurrency)
- **Фреймворк**: SwiftUI (Observation framework, новейшие API)
- **Локальное хранилище**: SQLite через GRDB.swift (использовать только статическую библиотеку GRDB)
- **Гео-индексация**: H3 через **SwiftyH3** (URL: `https://github.com/pawelmajcher/SwiftyH3.git`)
- **Карты**: Google Maps SDK for iOS
- **Стиль кода**: Функциональное программирование, лаконичность.

## Структура проекта
Все исходные файлы должны располагаться согласно следующей иерархии:
- `Sources/App/`: Точка входа в приложение и жизненный цикл.
- `Sources/Core/`: Бизнес-логика.
    - `Sources/Core/Model/`: Модели данных (PollenTile, DiaryEntry). Используют CodingKeys для маппинга в snake_case (БД).
    - `Sources/Core/Storage/`: Работа с SQLite (DatabaseManager).
    - `Sources/Core/Services/`: Внешние API (Google Pollen, Google Air Quality, Tomorrow.io), LocationManager, NotificationService, PersonalRiskService, BackgroundRefreshService.
    - `Sources/Core/Algorithms/`: Алгоритмы расчета риска и H3.
- `Sources/UI/`: Пользовательский интерфейс.
    - `Sources/UI/Screens/`: Основные экраны (MapView, DiaryView, HistoryView).
    - `Sources/UI/Components/`: Переиспользуемые View.
    - `Sources/UI/Theme/`: Цвета, шрифты, константы (Constants.swift).
- `Sources/Resources/`: Ассеты, кастомные стили (MapStyle.json).
- `Config/`: Конфигурационные файлы.
    - `Config/App-Info.plist`: Основной Info.plist (вынесен сюда во избежание дублирования при синхронизации папок).
    - `Config/Keys.xcconfig`: Секретные API ключи (в .gitignore).

## Дизайн-код
- **Стиль**: Современный, минималистичный, полноэкранная карта, парящие элементы (floating UI) с Ultra Thin Material.
- **Карты**: Стандартная цветовая схема Google Maps (синяя вода, зеленые зоны).
- **Индикация состояний**: Неактивные вкладки/кнопки должны использовать серые оттенки или прозрачность.
- **Индикация риска**: Использовать шкалу (Серый < Желтый < Оранжевый < Красный).

## Правила работы с библиотеками (Knowledge Base)
### SwiftyH3 (H3)
- **Импорт**: `import SwiftyH3`
- **Типы**: `H3Cell`, `H3LatLng`, `H3Cell.Resolution`.
- **Координаты в Индекс**: `CLLocationCoordinate2D.h3LatLng.cell(at: .res8)`.
- **Границы (Boundary)**: `cell.boundary` возвращает массив `H3LatLng`, которые нужно конвертировать через `.coordinates`.
- **Соседи**: `cell.gridRing(distance: 1)` для получения соседних ячеек.

### GRDB
- Использовать только таргет `GRDB` (избегать `GRDB-dynamic` или `GRDBSQLite`).
- Модели должны явно указывать `databaseTableName`.

### Google Maps
- Инициализация через `GMSMapViewOptions`.
- Стиль карты загружается из `MapStyle.json`.

### Google Pollen & Air Quality API
- Являются основными источниками данных. Tomorrow.io — резервный для пыльцы.
- Требуют заголовок `X-Ios-Bundle-Identifier` для корректной работы с ограниченными ключами.
- Air Quality API использует POST запрос к `currentConditions:lookup`.

## Алгоритм оценки риска (Кратко)
1. Нормализация данных (0-5 -> 0-500).
2. Z-фильтр (временной): `(p[t-1] + p[t] + p[t+1]) / 3`.
3. Ветровая коррекция: учет соседних H3-тайлов.
4. **Итоговая формула**: `(tree*0.4 + grass*0.3 + weed*0.3) * (1 + AQI*0.005)`. Учет синергии пыльцы и загрязнения воздуха.
5. **Байесовское обновление**: `PersonalRiskService` корректирует порог `riskThreshold` на основе записей в `DiaryEntry`.

## Уведомления
- `NotificationService` отвечает за запрос разрешений и отправку пушей при превышении персонального уровня риска (>80%).

## Фоновые задачи и Геолокация
- **Background Refresh**: Использование `BackgroundRefreshService` (задача `com.pollenalert.refresh`) для ежечасного обновления данных.
- **Геолокация**: Для фоновой работы используется разрешение `Always`. В `LocationManager` должны быть включены `allowsBackgroundLocationUpdates` и отключено `pausesLocationUpdatesAutomatically`.
